<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#
" lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Creating a Portable Python Environment from Imports | Quansight Labs</title>
<link href="../../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="../../../../assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="../../../../assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../../../rss.xml">
<link rel="canonical" href="https://labs.quansight.org/blog/2020/06/portable-python-env/">
<link rel="icon" href="../../../../favicon.ico" sizes="16x16">
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
   tex2jax: {
       inlineMath: [ ['$','$'], ["\\(","\\)"], ],
       displayMath: [ ['$$','$$'], ["\\[","\\]"] ]
   },
   displayAlign: 'center', // Change this to 'center' to center equations.
   "HTML-CSS": {
       styles: {'.MathJax_Display': {"margin": 0}}
   }
});
</script><!--[if lt IE 9]><script src="../../../../assets/js/html5.js"></script><![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-163785882-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-163785882-1');
</script><link rel="stylesheet" type="text/css" href="../../../../assets/css/tipuesearch.css">
<meta name="author" content="Kim Pevey">
<meta property="description" content="Python environments provide sandboxes in which packages can be added.
Conda helps us deal with the requirements and dependencies of those packages.
Occasionally we find ourselves working in a constrai">
<link rel="prev" href="../ibis-an-idiomatic-flavor-of-sql-for-python-programmers/" title="Ibis: an idiomatic flavor of SQL for Python programmers" type="text/html">
<link rel="next" href="../../07/writing-docs-is-not-just-writing-docs/" title="Writing docs is not just writing docs" type="text/html">
<meta property="og:site_name" content="Quansight Labs">
<meta property="og:title" content="Creating a Portable Python Environment from Imports">
<meta property="og:url" content="https://labs.quansight.org/blog/2020/06/portable-python-env/">
<meta property="og:description" content="Python environments provide sandboxes in which packages can be added.
Conda helps us deal with the requirements and dependencies of those packages.
Occasionally we find ourselves working in a constrai">
<meta property="og:image" content="https://labs.quansight.org/images/QuansightLabs_logo_V2.png">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2020-06-30T14:39:56-05:00">
<meta property="article:tag" content="Conda">
<meta property="article:tag" content="Conda-Pack">
<meta property="article:tag" content="Depfinder">
<meta property="article:tag" content="Python">
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@quansightai">
<meta property="twitter:image" content="https://labs.quansight.org/images/QuansightLabs_logo_V2.png">
<link rel="stylesheet" href="../../../../assets/css/quansightlabs.css">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-expand-md static-top mb-4
navbar-dark bg-dark
"><div class="container">
<!-- This keeps the margins nice -->
        <a class="navbar-brand" href="https://labs.quansight.org/">
            <img src="../../../../images/QuansightLabs_logo_V1_white.png" alt="Quansight Labs" id="logo" class="d-inline-block align-top"></a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="bs-navbar">
            <ul class="navbar-nav mr-auto">
<li class="nav-item">
<a href="../../../../" class="nav-link">Home</a>
                </li>
<li class="nav-item">
<a href="../../../" class="nav-link">Blog</a>
                </li>
<li class="nav-item">
<a href="../../../../team/" class="nav-link">Team</a>
                </li>
<li class="nav-item">
<a href="../../../../projects/" class="nav-link">Projects</a>
                </li>
<li class="nav-item">
<a href="../../../../about/" class="nav-link">About</a>
                </li>
<li class="nav-item">
<a href="../../../../rss.xml" class="nav-link">RSS</a>

                
            </li>
</ul>
<form class="navbar-form navbar-left" action="../../../../search" role="search">
    <div class="form-group">
        <input type="text" class="form-control" id="tipue_search_input" name="q" placeholder="Search…" autocomplete="off">
</div>
    <input type="submit" value="Local Search" style="visibility: hidden;"><!-- button type="submit" class="btn btn-default">Submit</button -->
</form>


            <ul class="navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
        
        
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name">
                <a href="." class="u-url">Creating a Portable Python Environment from Imports</a>
            </h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    <a class="u-url" href="../../../../authors/kim-pevey/">Kim Pevey</a>
            </span></p>
            <p class="dateline">
            <a href="." rel="bookmark">
            <time class="published dt-published" datetime="2020-06-30T14:39:56-05:00" itemprop="datePublished" title="2020-06-30">2020-06-30</time></a>
            </p>
            

        </div>
        
        <ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../../../categories/conda/" rel="tag">Conda</a></li>
            <li><a class="tag p-category" href="../../../../categories/conda-pack/" rel="tag">Conda-Pack</a></li>
            <li><a class="tag p-category" href="../../../../categories/depfinder/" rel="tag">Depfinder</a></li>
            <li><a class="tag p-category" href="../../../../categories/python/" rel="tag">Python</a></li>
        </ul></header><div class="e-content entry-content" itemprop="articleBody text">
        <div>
<p>Python environments provide sandboxes in which packages can be added.
Conda helps us deal with the requirements and dependencies of those packages.
Occasionally we find ourselves working in a constrained remote machine which
can make development challenging. Suppose we wanted to take our exact dev
environment on the remote machine and recreate it on our local machine.
While conda relieves the package dependency challenge, it can be hard to
reproduce the exact same environment.</p>
<!-- TEASER_END -->

<h2>Creating a Portable Python Environment</h2>
<p>This walkthrough will demonstrate a method to copy an exact environment on
one machine and transfer it to a another machine. We'll start by collecting
the package requirements of a given set of python files, create an environment
based on those requirements, then export it as a tarball for distribution on a
target machine.</p>
<h3>Setup</h3>
<h4>Sample files</h4>
<p>For this walkthrough we'll assume you have a folder with some python files
as a rudimentary "package".</p>
<p>If you want to create some example files, run the following commands:</p>
<p><code>mkdir -p ./test_package</code>
<code>echo "import scipy" &gt;&gt; ./test_package/first_file.py</code>
<code>echo "import numpy" &gt;&gt; ./test_package/first_file.py</code></p>
<p><code>echo "import pandas" &gt;&gt; ./test_package/second_file.py</code>
<code>echo "import sklearn" &gt;&gt; ./test_package/second_file.py</code></p>
<p>Each file has a few import statements - nothing fancy.</p>
<h3>Extracting the required packages</h3>
<p>In order to roll up the environment for the package, we first need to know what
the package requires. We will collect all the dependencies and create an environment file.</p>
<h4>Get direct dependencies</h4>
<p>The first step is to collect dependencies. We'll do this using
<a href="http://ericdill.github.io/depfinder/">depfinder</a>. It can be installed into your
environment:  <code>conda install -c conda-forge depfinder</code></p>
<p>This will be as simple as calling <code>depfinder</code> on our <code>test_package</code> directory.
We add the <code>-y</code> command to return yaml format.</p>
<p><code>depfinder -y ./test_package</code></p>
<p>This command returns a YAML formatted list with our dependencies. We are interested
in the <code>required</code> dependencies, which are the external package requirements.</p>
<pre class="code literal-block"><span></span><code><span class="nt">required</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">numpy</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">pandas</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">scikit-learn</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">scipy</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ipython</span>
</code></pre>


<h4>Create a temporary environment</h4>
<p>Now we have a list of the direct dependencies but what about all the sub-dependencies?
To capture these, we'll create a temporary environment.</p>
<p>Copy the yaml formatted dependencies into an environment file named <code>environment.yml</code>.</p>
<pre class="code literal-block"><span></span><code><span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">my_env</span>
<span class="nt">channels</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">conda-forge</span>
<span class="nt">dependencies</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">python&gt;=3.7</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">numpy</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">pandas</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">scikit-learn</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">scipy</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ipython</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">conda-pack</span>
</code></pre>


<p>Notice that we've added two extra packages to our <code>environment.yml</code>.
In this example, we'll set a minimum python version to include in the package.
We could also have explicitly set the Python version. You may notice that we
have also added an additional package called called <code>conda-pack</code>. This will be used
for wrapping up the environment for distribution - more on that later.</p>
<p>Create a conda environment from this yaml that will include all of the necessary
dependencies.</p>
<p><code>conda env create -f environment.yml</code></p>
<p>Activate the temporary conda env:</p>
<p><code>conda activate my_env</code></p>
<h3>Wrap up the environment into a tarball</h3>
<p>At this point, we're ready to wrap up our environment into a single tarball.
To do this, we'll use a package called <code>conda-pack</code>. <code>Conda-pack</code> is going to help us
wrap up our exact environment, including python itself. This means that the target machine
is not required to have python installed for this environment to be utilized. Much of what
follows is taken directly from the <code>conda-pack</code> docs.</p>
<p>Pack environment my_env into out_name.tar.gz</p>
<p><code>conda pack -n my_env -o my_env.tar.gz</code></p>
<h3>Unpacking the environment on the target machine</h3>
<p>At this point you will have a portable tarball that you can send to a different
machine. Note that the tarball you've created must only be used on target machines
with the same operating system.</p>
<p>Now we'll go over how to unpack the tarball on the target machine and utilize this
environment.</p>
<p>Unpack environment into directory <code>my_env</code>:</p>
<p><code>$ mkdir -p my_env</code>
<code>$ tar -xzf my_env.tar.gz -C my_env</code></p>
<p>We could stop here and start using the python environment directly. Note that most
Python libraries will work fine, but things that require prefix cleanups (since
we've built it in one directory and moved to another) will fail.</p>
<p><code>$ ./my_env/bin/python</code></p>
<p>Alternatively we could activate the environment. This adds <code>my_env/bin</code> to your path</p>
<p><code>$ source my_env/bin/activate</code></p>
<p>And then run python from the activated environment</p>
<p><code>(my_env) $ python</code></p>
<p>Cleanup prefixes from inside the active environment.
Note that this command can also be run without activating the environment
as long as some version of python is already installed on the machine.</p>
<p><code>(my_env) $ conda-unpack</code></p>
<p>At this point the environment is exactly as if you installed it here
using conda directly. All scripts should be fully functional, e.g.:</p>
<p><code>(my_env) $ ipython --version</code></p>
<p>When you're done, you may deactivate the environment to remove it from your path</p>
<p><code>(my_env) $ source my_env/bin/deactivate</code></p>
<h3>Conclusion</h3>
<p>We've successfully collected the Python package requirements for a set of Python files.
We've created the environment to run those files and wrapped that environment into a
tarball. Finally, we distributed the tarballed environment onto a different machine and
were immediately able to utilize an identical copy of Python environment from the
original machine.</p>
</div>
    </div>
    <aside class="postpromonav"><nav><ul class="pager hidden-print">
<li class="previous">
                <a href="../ibis-an-idiomatic-flavor-of-sql-for-python-programmers/" rel="prev" title="Ibis: an idiomatic flavor of SQL for Python programmers">Previous post</a>
            </li>

            <li class="archive">
                <a href="../../../../archive.html" rel="archive" title="Archive ">Archive</a>
            </li>

            <li class="next">
                <a href="../../07/writing-docs-is-not-just-writing-docs/" rel="next" title="Writing docs is not just writing docs">Next post</a>
            </li>
        </ul></nav></aside></article><!--End of body content--><footer id="footer">
            Contents © 2021         <a href="../../../../team">Quansight Labs Team</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
            
        </footer>
</div>
</div>


        <script src="../../../../assets/js/all-nocdn.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script>
</body>
</html>
